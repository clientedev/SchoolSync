{% extends "base.html" %}

{% block title %}Cursos - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-graduation-cap me-2"></i>Cursos
            </h1>
            <div class="btn-group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#courseModal" onclick="resetCourseToAddMode()">
                    <i class="fas fa-plus me-1"></i>Novo Curso
                </button>
                <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Opções de importação</span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('download_courses_template') }}">
                            <i class="fas fa-download me-2"></i>Baixar Modelo Excel
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal">
                            <i class="fas fa-file-excel me-2"></i>Importar Excel
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Courses List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if courses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Curso</th>
                                    <th>Período</th>
                                    <th>Componente Curricular</th>
                                    <th>Código da Turma</th>
                                    <th>Avaliações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in courses %}
                                    <tr>
                                        <td>
                                            <strong>{{ course.name }}</strong>
                                            {% if course.curricular_units %}
                                            <br><small class="text-muted">
                                                <i class="fas fa-book me-1"></i>
                                                {{ course.curricular_units|length }} unidade(s) curricular(es)
                                            </small>
                                            {% endif %}
                                        </td>
                                        <td>{{ course.period }}</td>
                                        <td>
                                            {{ course.curriculum_component }}
                                            {% if course.curricular_units %}
                                            <div class="mt-2">
                                                {% for unit in course.curricular_units[:3] %}
                                                <span class="badge bg-light text-dark me-1">{{ unit.name }}</span>
                                                {% endfor %}
                                                {% if course.curricular_units|length > 3 %}
                                                <span class="badge bg-secondary">+{{ course.curricular_units|length - 3 }} mais</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if course.class_code %}
                                                <span class="badge bg-secondary">{{ course.class_code }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ course.evaluations|length }}</span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        onclick="editCourse({{ course.id }}, '{{ course.name }}', '{{ course.period }}', '{{ course.curriculum_component }}', '{{ course.class_code or '' }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-info" 
                                                        onclick="manageCurricularUnits({{ course.id }}, '{{ course.name }}')">
                                                    <i class="fas fa-book"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="confirmDelete('{{ course.name }}', '{{ url_for('delete_course', id=course.id) }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum curso cadastrado</h5>
                        <p class="text-muted">Clique em "Novo Curso" para começar.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Course Modal -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="courseForm" method="POST" action="{{ url_for('add_course') }}">
                {{ form.hidden_tag() if form }}
                <div class="modal-header">
                    <h5 class="modal-title" id="courseModalLabel">
                        <span id="modalTitle">Novo Curso</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if form %}
                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control") }}
                            {% if form.name.errors %}
                                <div class="text-danger small">
                                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.period.label(class="form-label") }}
                                {{ form.period(class="form-control") }}
                                <small class="form-text text-muted">Ex: 1° Sem/25, 2° Sem/25</small>
                                {% if form.period.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.period.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.class_code.label(class="form-label") }}
                                {{ form.class_code(class="form-control") }}
                                {% if form.class_code.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.class_code.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.curriculum_component.label(class="form-label") }}
                            {{ form.curriculum_component(class="form-control") }}
                            {% if form.curriculum_component.errors %}
                                <div class="text-danger small">
                                    {% for error in form.curriculum_component.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Curricular Units Section -->
                        <div class="mb-3">
                            <label class="form-label">Unidades Curriculares</label>
                            <div id="curricularUnitsContainer">
                                <div class="input-group mb-2 curricular-unit-field">
                                    <input type="text" class="form-control" name="curricular_units[]" placeholder="Nome da Unidade Curricular 1" required>
                                    <input type="hidden" name="curricular_unit_ids[]" value="">
                                    <button type="button" class="btn btn-outline-success" onclick="addCurricularUnitField()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted">Adicione pelo menos uma unidade curricular. Clique em + para adicionar mais.</small>
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o curso <strong id="deleteItemName"></strong>?</p>
                <p class="text-danger small">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i>Excluir
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Import Excel Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="importForm" method="POST" action="{{ url_for('import_courses_excel') }}" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">
                        <i class="fas fa-file-excel me-2"></i>Importar Cursos via Excel
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Antes de importar:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Baixe o modelo Excel clicando em "Baixar Modelo Excel"</li>
                            <li>Preencha os dados dos cursos no arquivo</li>
                            <li>Salve o arquivo e selecione-o abaixo</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="excel_file" class="form-label">
                            <i class="fas fa-file me-1"></i>Arquivo Excel
                        </label>
                        <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                        <div class="form-text">Formatos aceitos: .xlsx, .xls (máximo 10MB)</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> Cursos com nomes duplicados serão ignorados.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" disabled>
                        <i class="fas fa-upload me-1"></i>Importar Cursos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Function to reset modal to "Add Course" mode
function resetCourseToAddMode() {
    console.log('🔧 DEBUG: Resetting course modal to ADD mode');
    document.getElementById('modalTitle').textContent = 'Novo Curso';
    document.getElementById('courseForm').action = "{{ url_for('add_course') }}";
    document.getElementById('courseForm').method = 'POST';
    document.getElementById('courseForm').reset();
    console.log('🔧 DEBUG: Course form action set to:', document.getElementById('courseForm').action);
    
    // Reset curricular units to single field
    resetCurricularUnitsToDefault();
}

function editCourse(id, name, period, curriculum_component, class_code) {
    document.getElementById('modalTitle').textContent = 'Editar Curso';
    document.getElementById('courseForm').action = `/courses/edit/${id}`;
    
    // Populate form fields
    document.querySelector('input[name="name"]').value = name;
    document.querySelector('input[name="period"]').value = period;
    document.querySelector('input[name="curriculum_component"]').value = curriculum_component;
    document.querySelector('input[name="class_code"]').value = class_code;
    
    // Load existing curricular units for this course
    loadCurricularUnitsForEdit(id);
    
    // Show modal
    new bootstrap.Modal(document.getElementById('courseModal')).show();
}

function confirmDelete(itemName, deleteUrl) {
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('confirmDeleteBtn').href = deleteUrl;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Reset form when modal is closed - use the same resetCourseToAddMode function
document.getElementById('courseModal').addEventListener('hidden.bs.modal', function () {
    resetCourseToAddMode();
});

// Also reset when modal is shown for new course (double safety)
document.getElementById('courseModal').addEventListener('show.bs.modal', function (event) {
    const triggerButton = event.relatedTarget;
    // If triggered by the "Novo Curso" button, ensure it's in add mode
    if (triggerButton && triggerButton.textContent.includes('Novo Curso')) {
        resetCourseToAddMode();
    }
});

// Function to add new curricular unit field (legacy support)
function addCurricularUnit() {
    addCurricularUnitField();
}

// Function to remove curricular unit field (legacy support)
function removeCurricularUnit(button) {
    removeCurricularUnitField(button);
}

// Import file validation and button control
document.getElementById('excel_file').addEventListener('change', function() {
    const file = this.files[0];
    const submitBtn = document.querySelector('#importForm button[type="submit"]');
    const existingInfo = document.getElementById('fileInfo');
    
    // Remove existing file info
    if (existingInfo) {
        existingInfo.remove();
    }
    
    if (file) {
        // Validate file type
        const validTypes = ['.xlsx', '.xls', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
        const isValidType = validTypes.some(type => 
            file.name.toLowerCase().endsWith(type) || file.type === type
        );
        
        // Validate file size (10MB max)
        const maxSize = 10 * 1024 * 1024;
        const isValidSize = file.size <= maxSize;
        
        if (isValidType && isValidSize) {
            // Create file info element
            const fileInfo = document.createElement('div');
            fileInfo.id = 'fileInfo';
            fileInfo.className = 'alert alert-success mt-2';
            fileInfo.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Arquivo selecionado:</strong> ${file.name} (${(file.size / 1024).toFixed(1)} KB)
            `;
            this.parentElement.appendChild(fileInfo);
            
            submitBtn.disabled = false;
        } else {
            // Show error
            const fileInfo = document.createElement('div');
            fileInfo.id = 'fileInfo';
            fileInfo.className = 'alert alert-danger mt-2';
            
            if (!isValidType) {
                fileInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Erro:</strong> Formato de arquivo não suportado.';
            } else if (!isValidSize) {
                fileInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Erro:</strong> Arquivo muito grande (máximo 10MB).';
            }
            
            this.parentElement.appendChild(fileInfo);
            submitBtn.disabled = true;
        }
    } else {
        submitBtn.disabled = true;
    }
});

// Reset import form when modal is closed
document.getElementById('importModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('importForm').reset();
    const importBtn = document.querySelector('#importForm button[type="submit"]');
    importBtn.disabled = true;
    const infoElement = document.getElementById('fileInfo');
    if (infoElement) {
        infoElement.remove();
    }
});

// Initialize import button as disabled
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.querySelector('#importForm button[type="submit"]');
    if (importBtn) {
        importBtn.disabled = true;
    }
});

function manageCurricularUnits(courseId, courseName) {
    // Redirect to curricular units page with course filter
    window.location.href = `/curricular_units?course_id=${courseId}`;
}

// Function to load curricular units for editing
function loadCurricularUnitsForEdit(courseId) {
    fetch(`/api/courses/${courseId}/curricular_units`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateCurricularUnitsForEdit(data.units);
            } else {
                console.error('Error loading curricular units:', data.error);
                // Fall back to single empty field
                resetCurricularUnitsToDefault();
            }
        })
        .catch(error => {
            console.error('Error loading curricular units:', error);
            resetCurricularUnitsToDefault();
        });
}

// Function to populate curricular units in edit mode
function populateCurricularUnitsForEdit(units) {
    const container = document.getElementById('curricularUnitsContainer');
    container.innerHTML = '';
    
    if (units && units.length > 0) {
        units.forEach((unit, index) => {
            addCurricularUnitField(unit.name, unit.id, index === 0);
        });
    } else {
        // Add one empty field if no units exist
        addCurricularUnitField('', null, true);
    }
}

// Enhanced function to add curricular unit field with optional data
function addCurricularUnitField(name = '', unitId = null, isFirst = false) {
    const container = document.getElementById('curricularUnitsContainer');
    const currentFields = container.querySelectorAll('.curricular-unit-field');
    
    if (currentFields.length >= 10) {
        alert('Máximo de 10 unidades curriculares permitido.');
        return;
    }
    
    const newField = document.createElement('div');
    newField.className = 'input-group mb-2 curricular-unit-field';
    newField.innerHTML = `
        <input type="text" class="form-control" name="curricular_units[]" 
               value="${name}" 
               placeholder="Nome da Unidade Curricular ${currentFields.length + 1}" 
               ${isFirst ? 'required' : ''}>
        <input type="hidden" name="curricular_unit_ids[]" value="${unitId || ''}">
        <button type="button" class="btn ${isFirst && currentFields.length === 0 ? 'btn-outline-success' : 'btn-outline-danger'}" 
                onclick="${isFirst && currentFields.length === 0 ? 'addCurricularUnitField()' : 'removeCurricularUnitField(this)'}">
            <i class="fas ${isFirst && currentFields.length === 0 ? 'fa-plus' : 'fa-minus'}"></i>
        </button>
    `;
    
    container.appendChild(newField);
    
    // Update the first button to add/remove as needed
    updateCurricularUnitButtons();
}

// Function to remove curricular unit field
function removeCurricularUnitField(button) {
    const container = document.getElementById('curricularUnitsContainer');
    const fields = container.querySelectorAll('.curricular-unit-field');
    
    if (fields.length > 1) {
        button.parentElement.remove();
        updateCurricularUnitButtons();
        
        // Update placeholders
        const remainingInputs = container.querySelectorAll('input[name="curricular_units[]"]');
        remainingInputs.forEach((input, index) => {
            input.placeholder = `Nome da Unidade Curricular ${index + 1}`;
            input.required = index === 0; // Only first field is required
        });
    }
}

// Function to update buttons in curricular unit fields
function updateCurricularUnitButtons() {
    const container = document.getElementById('curricularUnitsContainer');
    const fields = container.querySelectorAll('.curricular-unit-field');
    
    fields.forEach((field, index) => {
        const button = field.querySelector('button');
        const icon = button.querySelector('i');
        
        if (index === 0 && fields.length === 1) {
            // First and only field - should be Add button
            button.className = 'btn btn-outline-success';
            button.onclick = () => addCurricularUnitField();
            icon.className = 'fas fa-plus';
        } else {
            // Any other field - should be Remove button
            button.className = 'btn btn-outline-danger';
            button.onclick = () => removeCurricularUnitField(button);
            icon.className = 'fas fa-minus';
        }
    });
}

// Function to reset curricular units to default state
function resetCurricularUnitsToDefault() {
    const container = document.getElementById('curricularUnitsContainer');
    container.innerHTML = `
        <div class="input-group mb-2 curricular-unit-field">
            <input type="text" name="curricular_units[]" class="form-control" 
                   placeholder="Digite o nome da unidade curricular" required>
            <input type="hidden" name="curricular_unit_ids[]" value="">
            <button type="button" class="btn btn-outline-success" onclick="addCurricularUnitField()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `;
}
</script>
{% endblock %}
